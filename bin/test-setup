#!/usr/bin/env bash
#
# Idempotent WordPress test environment setup.
#
# Designed to be run on the HOST (it shells into the "wp" container).
# Safe to re-run: drops + recreates the test DB each time.
#
set -euo pipefail

# ---------- helpers ----------
log()  { printf '\033[1;34m▸ %s\033[0m\n' "$*"; }
die()  { printf '\033[1;31m✖ %s\033[0m\n' "$*" >&2; exit 1; }

DC="docker compose"

# ---------- 1. Bring containers up ----------
log "Starting containers …"
$DC up -d --build --wait || die "docker compose up failed"

# ---------- 2. Install runtime packages (Alpine apk, idempotent) ----------
log "Installing runtime packages inside wp container …"
$DC exec wp sh -c 'apk add --no-cache mariadb-client bash git unzip curl 2>/dev/null || true'

# ---------- 3. Wait for DB inside wp container ----------
log "Waiting for DB to be reachable from the wp container …"
$DC exec wp bash -c '
  for i in $(seq 1 30); do
    mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" -e "SELECT 1" &>/dev/null && exit 0
    sleep 1
  done
  echo "DB not reachable after 30s" >&2; exit 1
' || die "DB never became reachable"

# ---------- 4. (Re)create the test database ----------
log "Dropping and recreating database …"
$DC exec wp bash -c '
  mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" \
    -e "DROP DATABASE IF EXISTS \`$DB_NAME\`; CREATE DATABASE \`$DB_NAME\`;"
'

# ---------- 5. Download WordPress core (idempotent) ----------
log "Ensuring WordPress core is present …"
$DC exec wp bash -c '
  if [ ! -f /var/www/html/wp-load.php ]; then
    wp core download --path=/var/www/html --allow-root
  fi
'

# ---------- 6. Create wp-config.php ----------
log "Generating wp-config.php …"
$DC exec wp bash -c '
  wp config create \
    --path=/var/www/html \
    --dbname="$DB_NAME" \
    --dbuser="$DB_USER" \
    --dbpass="$DB_PASS" \
    --dbhost="$DB_HOST" \
    --force \
    --allow-root
'

# ---------- 7. Install WordPress ----------
log "Installing WordPress …"
$DC exec wp bash -c '
  wp core install \
    --path=/var/www/html \
    --url="$WP_URL" \
    --title="$WP_TITLE" \
    --admin_user="$WP_ADMIN_USER" \
    --admin_password="$WP_ADMIN_PASS" \
    --admin_email="$WP_ADMIN_EMAIL" \
    --skip-email \
    --allow-root
'

# ---------- 8. Symlink plugin & activate ----------
log "Linking and activating plugin …"
$DC exec wp bash -c '
  DEST="/var/www/html/wp-content/plugins/$PLUGIN_SLUG"
  rm -rf "$DEST"
  ln -sfn "$PLUGIN_DIR" "$DEST"
  wp plugin activate "$PLUGIN_SLUG" --path=/var/www/html --allow-root
'

# ---------- 9. Start PHP built-in server (serves WordPress on :8080) ----------
log "Starting PHP built-in web server on :8080 …"
$DC exec -d wp bash -c '
  kill $(cat /tmp/php-server.pid 2>/dev/null) 2>/dev/null || true
  php -S 0.0.0.0:8080 -t /var/www/html &>/tmp/php-server.log &
  echo $! > /tmp/php-server.pid
'

# ---------- 10. Start ChromeDriver (WebDriver on :9515) ----------
log "Starting ChromeDriver on :9515 …"
$DC exec -d wp bash -c '
  kill $(cat /tmp/chromedriver.pid 2>/dev/null) 2>/dev/null || true
  chromedriver --port=9515 --allowed-ips="" &>/tmp/chromedriver.log &
  echo $! > /tmp/chromedriver.pid
'

# ---------- 11. Wait for WordPress HTTP ----------
log "Waiting for WordPress to respond over HTTP …"
$DC exec wp bash -c '
  for i in $(seq 1 15); do
    if curl -sfo /dev/null http://127.0.0.1:8080/ 2>/dev/null; then
      exit 0
    fi
    sleep 1
  done
  echo "WordPress HTTP not reachable after 15s" >&2; exit 1
' || die "WordPress never became reachable over HTTP"

# ---------- 12. Install Composer deps (if needed) ----------
log "Installing Composer dependencies …"
$DC exec wp bash -c '
  cd /app && composer install --no-interaction --prefer-dist
'

# ---------- 13. Build Codeception support classes ----------
log "Building Codeception actors …"
$DC exec wp bash -c '
  cd /app && vendor/bin/codecept build
'

log "Setup complete ✔"
